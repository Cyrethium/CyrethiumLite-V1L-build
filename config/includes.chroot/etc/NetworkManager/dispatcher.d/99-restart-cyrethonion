#!/bin/bash

# DISABLED: NetworkManager hook to restart cyrethonion when internet connection is restored
# /etc/NetworkManager/dispatcher.d/99-restart-cyrethonion

exit 0  # Script disabled

INTERFACE=$1
STATUS=$2

# Check if cyrethonion-autostart service is enabled
if ! systemctl is-enabled cyrethonion-autostart &>/dev/null; then
    exit 0
fi

# If connection is up (interface is up and online)
if [ "$STATUS" = "up" ] || [ "$STATUS" = "connectivity-change" ]; then
    # Check if we have actual internet connectivity by pinging cloudflare DNS
    if ping -c 1 -W 2 1.1.1.1 &>/dev/null; then
        logger -t "cyrethonion-nm-hook" "Internet connection detected, restarting cyrethonion"
        # Give the network some time to fully stabilize
        sleep 2
        
        # Restart cyrethonion directly
        /usr/bin/cyrethonion restart
        
        logger -t "cyrethonion-nm-hook" "Cyrethonion restart completed"
    fi
fi

exit 0
