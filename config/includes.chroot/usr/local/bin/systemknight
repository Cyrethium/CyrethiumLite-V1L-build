#!/bin/bash

# SystemKnight - Malware and Rootkit Scanner Manager for Securonis
# A tool to easily manage ClamAV and rkhunter scans

# Colors for terminal output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[1;94m'
NC='\033[0m' # No Color

# Get the real user's home directory when run with sudo
if [ -n "$SUDO_USER" ]; then
    REAL_HOME=$(eval echo ~$SUDO_USER)
else
    REAL_HOME=$HOME
fi

# Check if running as root
check_root() {
    if [ "$(id -u)" -ne 0 ]; then
        echo -e "${RED}Error: This script must be run as root"
        exit 1
    fi
}

# Check if required tools are installed
check_dependencies() {
    local missing_deps=0
    
    echo -e "${BLUE}Checking dependencies..."
    
    # Check for ClamAV
    if ! command -v clamscan &> /dev/null; then
        echo -e "${YELLOW}ClamAV is not installed."
        missing_deps=1
    else
        echo -e "${GREEN}ClamAV is installed."
    fi
    
    # Check for rkhunter
    if ! command -v rkhunter &> /dev/null; then
        echo -e "${YELLOW}rkhunter is not installed."
        missing_deps=1
    else
        echo -e "${GREEN}rkhunter is installed."
    fi
    
    if [ $missing_deps -eq 1 ]; then
        echo -e "${YELLOW}Would you like to install missing dependencies? (y/n)"
        read -r install_deps
        if [[ $install_deps =~ ^[Yy]$ ]]; then
            install_dependencies
        else
            echo -e "${RED}Cannot proceed without required dependencies."
            exit 1
        fi
    fi
}

# Install dependencies
install_dependencies() {
    echo -e "${BLUE}Installing dependencies..."
    apt-get update -y
    
    # Install ClamAV if not present
    if ! command -v clamscan &> /dev/null; then
        echo -e "${BLUE}Installing ClamAV..."
        apt-get install clamav clamav-daemon -y
        systemctl enable clamav-freshclam
        systemctl start clamav-freshclam
    fi
    
    # Install rkhunter if not present
    if ! command -v rkhunter &> /dev/null; then
        echo -e "${BLUE}Installing rkhunter..."
        apt-get install rkhunter -y
    fi
    
    echo -e "${GREEN}Dependencies installed successfully."
}

# Update virus definitions
update_definitions() {
    echo -e "${BLUE}Updating virus definitions..."
    
    # Update ClamAV database
    echo -e "${BLUE}Updating ClamAV database..."
    freshclam
    
    # Update rkhunter database
    echo -e "${BLUE}Updating rkhunter database..."
    rkhunter --update
    rkhunter --propupd
    
    echo -e "${GREEN}Virus and rootkit definitions updated successfully."
}

# Perform ClamAV scan
clamav_scan() {
    local scan_dir=$1
    local scan_options=$2
    
    echo -e "${BLUE}Starting ClamAV scan on ${scan_dir}..."
    echo -e "${YELLOW}This may take some time depending on the size of the directory."
    
    # Run the scan
    clamscan "$scan_dir" $scan_options
}

# Perform rkhunter scan
rkhunter_scan() {
    local scan_options=$1
    
    echo -e "${BLUE}Starting rkhunter scan..."
    echo -e "${YELLOW}This may take some time."
    
    # Run the scan
    rkhunter $scan_options
    
    echo -e "${GREEN}rkhunter scan completed."
}

# ClamAV scan menu
clamav_menu() {
    clear
    echo -e "${BLUE}============================================"
    echo -e "${BLUE}          SystemKnight - ClamAV Scan        "
    echo -e "${BLUE}============================================"
    echo -e "${GREEN}1. Quick scan (home directory)${NC}"
    echo -e "${GREEN}2. Full system scan${NC}"
    echo -e "${GREEN}3. Custom directory scan${NC}"
    echo -e "${GREEN}4. Scan and remove infected files${NC}"
    echo -e "${GREEN}5. Back to main menu${NC}"
    echo -e "${BLUE}============================================"
    echo -e "${YELLOW}Enter your choice [1-5]: ${NC}"
    read -r choice
    
    case $choice in
        1)
            clamav_scan "$REAL_HOME" "--recursive"
            ;;
        2)
            clamav_scan "/" "--recursive --exclude-dir=/proc --exclude-dir=/sys --exclude-dir=/dev"
            ;;
        3)
            echo -e "${YELLOW}Enter the directory path to scan: ${NC}"
            read -r custom_dir
            if [ -d "$custom_dir" ]; then
                clamav_scan "$custom_dir" "--recursive"
            else
                echo -e "${RED}Invalid directory path."
            fi
            ;;
        4)
            echo -e "${YELLOW}WARNING: This will remove infected files. Are you sure? (y/n)"
            read -r confirm
            if [[ $confirm =~ ^[Yy]$ ]]; then
                echo -e "${YELLOW}Enter the directory path to scan and clean: ${NC}"
                read -r clean_dir
                if [ -d "$clean_dir" ]; then
                    clamav_scan "$clean_dir" "--recursive --remove"
                else
                    echo -e "${RED}Invalid directory path."
                fi
            fi
            ;;
        5)
            return
            ;;
        *)
            echo -e "${RED}Invalid option. Please try again."
            ;;
    esac
    
    echo -e "\nPress Enter to continue..."
    read -r
    clamav_menu
}

# rkhunter scan menu
rkhunter_menu() {
    clear
    echo -e "${BLUE}============================================"
    echo -e "${BLUE}        SystemKnight - rkhunter Scan        "
    echo -e "${BLUE}============================================"
    echo -e "${GREEN}1. Standard system check${NC}"
    echo -e "${GREEN}2. Check with only warnings displayed${NC}"
    echo -e "${GREEN}3. Thorough system check${NC}"
    echo -e "${GREEN}4. Back to main menu${NC}"
    echo -e "${BLUE}============================================"
    echo -e "${YELLOW}Enter your choice [1-4]: ${NC}"
    read -r choice
    
    case $choice in
        1)
            rkhunter_scan "--check"
            ;;
        2)
            rkhunter_scan "--check --rwo"
            ;;
        3)
            rkhunter_scan "--check --sk"
            ;;
        4)
            return
            ;;
        *)
            echo -e "${RED}Invalid option. Please try again."
            ;;
    esac
    
    echo -e "\nPress Enter to continue..."
    read -r
    rkhunter_menu
}

# Display ASCII art logo
display_logo() {
cat << "EOF"

            _
 _         | |
| | _______| |---------------------------------------------\
| -)_______|==[]============================================>
|_|        | |---------------------------------------------/
           |_|  

EOF
}

# Install SystemKnight dependencies
install_systemknight() {
    clear
    echo -e "${BLUE}============================================"
    echo -e "${BLUE}       SystemKnight Installation Menu       "
    echo -e "${BLUE}============================================"
    echo -e "${BLUE}Installing dependencies...${NC}"
    
    # Install dependencies
    apt-get update -y
    apt-get install clamav clamav-daemon rkhunter -y
    
    # Enable and start services
    systemctl enable clamav-freshclam
    systemctl start clamav-freshclam
    
    echo -e "${GREEN}Installation completed successfully!"
    echo -e "\nPress Enter to continue..."
    read -r
}

# Main menu
main_menu() {
    while true; do
        clear
        display_logo
        echo -e "${BLUE}============================================"
        echo -e "${BLUE}                SystemKnight               "
        echo -e "${BLUE}     Malware and Rootkit Scan Manager      "
        echo -e "${BLUE}============================================"
        echo -e "${GREEN}1. ClamAV Scan (Malware Detection)${NC}"
        echo -e "${GREEN}2. rkhunter Scan (Rootkit Detection)${NC}"
        echo -e "${GREEN}3. Update All Definitions${NC}"
        echo -e "${GREEN}4. System Information${NC}"
        echo -e "${GREEN}5. Install Dependencies${NC}"
        echo -e "${GREEN}6. Exit${NC}"
        echo -e "${BLUE}============================================"
        echo -e "${YELLOW}Enter your choice [1-6]: ${NC}"
        read -r choice
        
        case $choice in
            1)
                clamav_menu
                ;;
            2)
                rkhunter_menu
                ;;
            3)
                update_definitions
                echo -e "\nPress Enter to continue..."
                read -r
                ;;
            4)
                clear
                echo -e "${BLUE}============================================"
                echo -e "${BLUE}           System Information              "
                echo -e "${BLUE}============================================"
                echo -e "${YELLOW}Hostname: $(hostname)"
                echo -e "${YELLOW}Kernel: $(uname -r)"
                echo -e "${YELLOW}OS: $(grep PRETTY_NAME /etc/os-release | cut -d= -f2 | tr -d '\"')"
                echo -e "${YELLOW}ClamAV Version: $(clamscan --version)"
                echo -e "${YELLOW}rkhunter Version: $(rkhunter --version)"
                echo -e "${BLUE}============================================"
                echo -e "\nPress Enter to continue..."
                read -r
                ;;
            5)
                install_systemknight
                ;;
            6)
                echo -e "${GREEN}Thank you for using SystemKnight. Goodbye!"
                exit 0
                ;;
            *)
                echo -e "${RED}Invalid option. Please try again."
                sleep 2
                ;;
        esac
    done
}

# Main execution
check_root
check_dependencies
main_menu